<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Watch</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <style>
        * {
            margin: 0px;
            border: 0px;
            padding: 0px;
            outline: none;
        }

        body, html {
            background: #040b10;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #map {
            position: fixed;
            bottom: 0px;
            top: 0px;
            right: 0px;
            left: 0px;
        }
        form {
            width: 100%;
            height: 100%;
            z-index: 2;
            position: fixed;
            opacity: 1;
            background: rgba(4, 11, 16, 0.9);
            transition: opacity 0.3s ease;
        }
        [name="name"] {
            width: 300px;
            max-width: calc(100% - 40px);
            height: 30px;
            background: #FFF;
            border-bottom: 3px solid #AAA;
            position: absolute;
            bottom: 0px;
            top: 0px;
            left: 0px;
            right: 0px;
            margin: auto;
            padding: 0px 10px;
        }
    </style>
</head>

<body>
<canvas id="map" width="100" height="100"></canvas>
<form>
    <input name="name" placeholder="Wocher name"/>
</form>
<script src="/socket.io/socket.io.js"></script>
<script>
    if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                window.oRequestAnimationFrame ||
                window.msRequestAnimationFrame ||
                function (callback) {
                    window.setTimeout(callback, 1000 / 60);
                };
    }
    var canvas = $("#map")[0],
            ctx = canvas.getContext("2d"),
            last = 0,
            players = {},
            socket = io(),
            sizes = {
                back: 4000,
                ball: 20
            },
            back = new Image(),
            view = ctx.createLinearGradient(0, 0, 0, 0);

    back.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/9/9f/Graph-paper.svg/1000px-Graph-paper.svg.png";

    $(window).resize(setCanvas);

    function setCanvas() {
        canvas.width = $(document).width();
        canvas.height = $(document).height();
        sizes.toEnd = Math.max($(document).height(), $(document).width());
        ctx.font = 'bold 15px Arial';
        ctx.textAlign = 'center';
    }

    $("form").on("submit",function (e) {
        socket.emit("join",{usr:$("[name='name']").val()});
        $(this).css("opacity",0);
        $(document).mousemove(function (e) {
            if (Date.now() - last > 20) {
                var distance = Math.sqrt(Math.pow(($(document).width() / 2) - e.pageX, 2) + Math.pow(($(document).height() / 2) - e.pageY, 2)),
                        angle = Math.atan2(e.pageY - $(document).height() / 2, e.pageX - $(document).width() / 2);
                socket.emit("i", {a: angle, d: distance});
                last = Date.now();
            }
        });
        e.preventDefault();
        return false;
    })
    setCanvas();
    (function draw() {
        var base = players["/#" + socket.id] ?  players["/#" + socket.id]: {x:0.5,y:0.5};
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(back, canvas.width / 2 - (sizes.back * base.x), canvas.height / 2 - (sizes.back * base.y), sizes.back, sizes.back);
            for (var id in players) {
                ctx.save();
                ctx.translate((canvas.width / 2) - (sizes.back * (base.x - players[id].x)), (canvas.height / 2) - (sizes.back * (base.y - players[id].y)));
                ctx.rotate(players[id].a + (Math.PI / 2));
                ctx.beginPath();
                ctx.arc(0, 0, sizes.ball, 0, 2 * Math.PI);
                ctx.closePath();
                ctx.fillStyle = "#FFF";
                ctx.fill();
                ctx.beginPath();
                ctx.arc(0, 0, sizes.ball, 0, Math.PI);
                ctx.lineTo(-(sizes.ball + 60) / 2, -sizes.toEnd);
                ctx.lineTo((sizes.ball + 60) / 2, -sizes.toEnd);
                ctx.closePath();
                view = ctx.createLinearGradient(0, 0, 0, -(sizes.toEnd * players[id].s));
                view.addColorStop(0.8, "#FFF");
                view.addColorStop(1, "rgba(255,255,255,0)");
                ctx.fillStyle = view;
                ctx.fill();
                ctx.fillStyle = "#999";
                ctx.rotate(-(players[id].a + (Math.PI / 2)));
                ctx.translate(0,5);
                ctx.fillText(players[id].n.substr(0,1).toUpperCase(),0,0,20);
                ctx.restore();
        }
        requestAnimationFrame(draw);
    })();

    $(window).on('beforeunload', function () {
        socket.disconnect();
    });
    socket.on("u", function (u) {
        players[u.id] = {x: u.x, y: u.y, a: u.a, s: u.s, n:u.n}
    })
    socket.on('d', function (id) {
        delete players[id];
    });
</script>
</body>
</html>
