function copy(a){for(var b=a.slice(0),c=b.length;c--;)b[c]instanceof Array?b[c]=copy(b[c]):b[c]instanceof Object&&(b[c]={});return b}var express=require("express"),app=express(),server=require("http").createServer(app),io=require("socket.io").listen(server),IP=process.env.OPENSHIFT_NODEJS_IP||"127.0.0.1",PORT=process.env.OPENSHIFT_NODEJS_PORT||process.env.PORT||8080,NumOfSections=10,Sections=function(){for(var a=[],b=NumOfSections;b--;){a[b]=[];for(var c=NumOfSections;c--;)a[b][c]={}}return a}(),GAMES=["A"],ServerRegion="Europe",games=function(){for(var a={},b=GAMES.length;b--;)a[GAMES[b]]={playing:{}};return a}(),Powers=[function(a){a.Power.state&&a.Power.time?(a.Beam.angle=Math.min(a.Beam.angle+.07,Math.PI/2),a.Power.time=Math.max(a.Power.time-.1,0)):(a.Beam.angle=Math.max(a.Beam.angle-.1,.7),a.Power.time=Math.min(a.Power.time+.05,100))}];setInterval(function(){for(var a in games){var b=games[a].sections=copy(Sections);for(var c in games[a].playing){var d=c;c=games[a].playing[c],c.Health.val?(Powers[c.Power.type](c),c.x=Math.min(Math.max(Math.cos(c.Angle)/(1e3/c.Speed.val)+c.x,0),1),c.y=Math.min(Math.max(Math.sin(c.Angle)/(1e3/c.Speed.val)+c.y,0),1),c.Score+=.185*c.Speed.val,c.Health.val=Math.min(c.Health.val+c.Health.regen,c.Health.max),b[~~(c.x*(NumOfSections-1e-9))][~~(c.y*(NumOfSections-1e-9))][d]=c):(io.sockets.sockets[d].emit("d",c.Health.Death),delete games[a].playing[d])}for(var e=NumOfSections;e--;){var f,g;f=0===e?[0,1]:e===NumOfSections-1?[NumOfSections-2,NumOfSections-1]:[e-1,e,e+1];for(var h=NumOfSections;h--;){g=0===h?[0,1]:h===NumOfSections-1?[NumOfSections-2,NumOfSections-1]:[h-1,h,h+1];for(c in b[e][h]){d=c,c=b[e][h][c],c.Near={},c.Near[d]={Name:c.Name,x:c.x,y:c.y,Speed:c.Speed,Angle:c.Angle,Beam:c.Beam,Health:c.Health.val,Score:c.Score};for(var i=f.length;i--;)for(var j=g.length;j--;){var k=b[f[i]][g[j]];for(var l in k)if(l!=d){var o,m=l,l=k[l],n=Math.atan2(l.y-c.y,l.x-c.x);(o=Math.sqrt(Math.pow(c.x-l.x,2)+Math.pow(c.y-l.y,2)))<c.Beam.length/9e3*c.Speed.val&&n<=c.Angle+c.Beam.angle&&n>=c.Angle-c.Beam.angle&&c.Health.val&&l.Health.val&&(c.Near[m]={Name:l.Name,x:l.x,y:l.y,Speed:l.Speed,Angle:l.Angle,Beam:l.Beam,Health:l.Health.val},l.Health.val=Math.max(l.Health.val-1,0),l.Health.val||(l.Health.Death={type:0,user:c.Name},c.Score+=500+.8*l.Score),c.Score+=2),o<.003&&(c.Health.Death={type:1,user:l.Name},l.Health.Death={type:0,user:c.Name},c.Health.val=0,l.Health.val=0)}c.Health.val&&io.sockets.sockets[d]&&io.sockets.sockets[d].emit("u",c.Near)}}}}}},20),setInterval(function(){for(var a in games){var b=[];for(var c in games[a].playing){var d=games[a].playing[c];b.push({Score:d.Score,ID:c,Name:d.Name})}io.to(a).emit("b",b.sort(function(a,b){return b.Score-a.Score}).slice(0,5))}},2e3),app.use(require("cors")()),app.use(express.static(__dirname+"/../static")),server.listen(PORT,function(){console.log("Listening at http://"+IP+":"+PORT)}),io.on("connection",function(a){var b={Health:{val:0}},c=Object.keys(games)[~~(Math.random()*Object.keys(games).length)];a.join(c),a.emit("si",{region:ServerRegion,name:c}),a.on("join",function(d){b.Health.val||(b={Name:d.usr?d.usr.toString().substr(0,20):"",x:Math.random(),y:Math.random(),Angle:0,Score:0,Health:{regen:.1,val:100,max:100},Speed:{val:0,max:.5},Beam:{length:500,angle:.7},Power:{type:0,state:0,time:10}},games[c].playing[a.id]=b)}),a.on("i",function(a){b.Health.val&&(b.Angle=parseFloat(a.a),b.Speed.val=Math.min(Math.max(parseFloat(a.d-30)/(b.Beam.length/2),0),b.Speed.max))}),a.on("p",function(a){b.Health.val&&(b.Power.state=a)}),a.on("leave",function(){delete games[c].playing[a.id],a.leave(c),c=Object.keys(games)[~~(Math.random()*Object.keys(games).length)],a.join(c),a.emit("si",{region:ServerRegion,name:c}),b={Health:{val:0}}}),a.on("disconnect",function(){b={Health:{val:0}},delete games[c].playing[a.id],console.log("Connection closed: "+a.id)}),console.log("New connection: "+a.id)});