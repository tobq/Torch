var express=require("express"),app=express(),server=require("http").createServer(app),io=require("socket.io").listen(server),IP=process.env.OPENSHIFT_NODEJS_IP||"127.0.0.1",PORT=process.env.OPENSHIFT_NODEJS_PORT||process.env.PORT||8080,NumOfSections=10,Sections=function(){for(var b=[],c=NumOfSections;c--;){b[c]=[];for(var a=NumOfSections;a--;)b[c][a]={}}return b}(),GAMES=["A"],ServerRegion="Europe",games=function(){for(var b={},c=GAMES.length;c--;)b[GAMES[c]]={playing:{}};return b}();
setInterval(function(){for(var b in games){var c=games[b].sections=copy(Sections),a;for(a in games[b].playing){var e=a;a=games[b].playing[a];a.Health.val?(a.x=Math.min(Math.max(Math.cos(a.Angle)/(1E3/a.Speed.val)+a.x,0),1),a.y=Math.min(Math.max(Math.sin(a.Angle)/(1E3/a.Speed.val)+a.y,0),1),a.Score+=.185*a.Speed.val,a.Health.val=Math.min(a.Health.val+a.Health.regen,a.Health.max),c[~~(a.x*(NumOfSections-1E-9))][~~(a.y*(NumOfSections-1E-9))][e]=a):(io.sockets.sockets[e].emit("d",a.Health.Death),delete games[b].playing[e])}for(var f=
    NumOfSections;f--;){var h,k;h=0===f?[0,1]:f===NumOfSections-1?[NumOfSections-2,NumOfSections-1]:[f-1,f,f+1];for(var g=NumOfSections;g--;)for(a in k=0===g?[0,1]:g===NumOfSections-1?[NumOfSections-2,NumOfSections-1]:[g-1,g,g+1],c[f][g]){e=a;a=c[f][g][a];a.Near={};a.Near[e]={Name:a.Name,x:a.x,y:a.y,Speed:a.Speed,Angle:a.Angle,Beam:a.Beam,Health:a.Health.val,Score:a.Score};for(var l=h.length;l--;)for(var m=k.length;m--;){var n=c[h[l]][k[m]],d;for(d in n)if(d!=e){var r=d;d=n[d];var p=Math.atan2(d.y-a.y,
    d.x-a.x),q;(q=Math.sqrt(Math.pow(a.x-d.x,2)+Math.pow(a.y-d.y,2)))<a.Beam.length/9E3*a.Speed.val&&p<=a.Angle+a.Beam.angle&&p>=a.Angle-a.Beam.angle&&(a.Near[r]={Name:d.Name,x:d.x,y:d.y,Speed:d.Speed,Angle:d.Angle,Beam:d.Beam,Health:d.Health.val},d.Health.val=Math.max(d.Health.val-1,0),d.Health.val||(d.Health.Death={type:1,user:a.Name},a.Score+=.8*d.Score),a.Score+=2);.003>q&&(a.Health.Death={type:0,user:d.Name},d.Health.Death={type:0,user:a.Name},a.Health.val=0,d.Health.val=0)}a.Health.val&&io.sockets.sockets[e]&&
io.sockets.sockets[e].emit("u",a.Near)}}}}},20);setInterval(function(){for(var b in games){var c=[],a;for(a in games[b].playing){var e=games[b].playing[a];c.push({Score:e.Score,ID:a,Name:e.Name})}io.to(b).emit("b",c.sort(function(a,b){return b.Score-a.Score}).slice(0,5))}},2E3);app.use(require("cors")());app.use(express["static"](__dirname+"/../static"));server.listen(PORT,function(){console.log("Listening at http://"+IP+":"+PORT)});
io.on("connection",function(b){var c={Health:{val:0}},a=Object.keys(games)[~~(Math.random()*Object.keys(games).length)];b.join(a);b.emit("si",{region:ServerRegion,name:a});b.on("join",function(e){c.Health.val||(c={Name:e.usr?e.usr.toString().substr(0,20):"",x:Math.random(),y:Math.random(),Angle:0,Score:0,Health:{regen:.1,val:100,max:100},Speed:{val:0,max:.5},Beam:{length:500,angle:.6}},games[a].playing[b.id]=c)});b.on("i",function(a){c.Health.val&&(c.Angle=parseFloat(a.a),c.Speed.val=Math.min(Math.max(parseFloat(a.d-
        30)/(c.Beam.length/2),0),c.Speed.max))});b.on("leave",function(){delete games[a].playing[b.id];b.leave(a);a=Object.keys(games)[~~(Math.random()*Object.keys(games).length)];b.join(a);b.emit("si",{region:ServerRegion,name:a});c={Health:{val:0}}});b.on("disconnect",function(){c={Health:{val:0}};delete games[a].playing[b.id];console.log("Connection closed: "+b.id)});console.log("New connection: "+b.id)});
function copy(b){b=b.slice(0);for(var c=b.length;c--;)b[c]instanceof Array?b[c]=copy(b[c]):b[c]instanceof Object&&(b[c]={});return b};