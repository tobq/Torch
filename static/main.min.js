function escapeHTML(a){var b={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return a.replace(/[&<>"']/g,function(a){return b[a]})}function setCanvas(){canvas.width=$(document).width(),canvas.height=$(document).height(),ctx.font="bold "+Math.round(.5*sizes.ball*sizes.scale)+"px Rubik",ctx.textAlign="center"}function toggleFPS(){var a=document.getElementById("fpsc"),b=document.getElementsByClassName("fps check")[0];FPS.calcFPS?(b.style.background="none",a.style.opacity=0,setTimeout(function(){a.className=""},300)):(b.style.background="#444",a.className="overlays",a.style.opacity=1),FPS.calcFPS=!FPS.calcFPS}function joinGame(){socket.emit("join",{usr:document.getElementById("wacher").value}),hideHome(),document.onmousemove=function(a){if(Date.now()-lastM>20){var b=Math.sqrt(Math.pow($(document).width()/2-a.pageX,2)+Math.pow($(document).height()/2-a.pageY,2))/sizes.scale,c=Math.atan2(a.pageY-$(document).height()/2,a.pageX-$(document).width()/2);socket.emit("i",{a:c,d:b}),lastM=Date.now()}}}function hideHome(){var a=document.getElementById("home");a.style.opacity=0,document.getElementById("output").innerHTML="",$(".overlays").css("opacity",1),$("button.settings").attr("style",""),$("section.settings").css({"max-height":40,"padding-top":0}).addClass("closed"),setTimeout(function(){a.style.zIndex=-1},300)}function openHome(){$("#home").css({opacity:1,"z-index":0}),$(".overlays").css("opacity",0),document.onmousemove=null}function toggleCoords(){var a=document.getElementById("coord"),b=document.getElementsByClassName("coord check")[0];b.style.background&&"none"!==b.style.background?(b.style.background="none",a.style.opacity=0,setTimeout(function(){a.className=""},300)):(b.style.background="#444",a.className="overlays",a.style.opacity=1)}window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)});var canvas=document.getElementById("map"),ctx=canvas.getContext("2d"),socket=io(),FPS={lastShow:0,lastCount:0,framesShown:0,calcFPS:!1,div:document.getElementById("fps")},sizes={back:{size:15e3,spacing:300,dotsize:4},ball:20,scale:1},lastM=0,players={},view="#FFF",Base;(window.onresize=setCanvas)(),$(window).keydown(function(a){27===a.which?openHome():16===a.which?toggleFPS():67===a.which&&toggleCoords()}),window.onwheel=function(a){sizes.scale=Math.min(Math.max(sizes.scale-a.deltaY/1500,300/(Base?Base.Beam.length:500)),2),ctx.font="bold "+Math.round(.5*sizes.ball*sizes.scale)+"px Rubik"},document.getElementById("play").onclick=joinGame,document.getElementById("inform").onsubmit=function(a){return joinGame(),a.preventDefault(),!1},function a(){var c,b=Base||{x:.5,y:.5},d=canvas.width/2-sizes.back.size*sizes.scale*b.x,e=canvas.height/2-sizes.back.size*sizes.scale*b.y,f=d%(sizes.back.spacing*sizes.scale),g=e%(sizes.back.spacing*sizes.scale);ctx.clearRect(0,0,canvas.width,canvas.height),ctx.fillStyle="rgba(255,255,255,0.1)",ctx.strokeStyle="rgba(255,255,255,0.1)",ctx.lineWidth=3*sizes.scale;for(var h=-sizes.back.spacing*sizes.scale;h<canvas.width+sizes.back.spacing*sizes.scale;h+=sizes.back.spacing*sizes.scale)for(var i=-sizes.back.spacing*sizes.scale;i<canvas.height+sizes.back.spacing*sizes.scale;i+=sizes.back.spacing*sizes.scale)ctx.beginPath(),ctx.moveTo(h+f-sizes.back.dotsize*sizes.scale,i+g-sizes.back.dotsize*sizes.scale),ctx.lineTo(h+f+sizes.back.dotsize*sizes.scale,i+g+sizes.back.dotsize*sizes.scale),ctx.moveTo(h+f+sizes.back.dotsize*sizes.scale,i+g-sizes.back.dotsize*sizes.scale),ctx.lineTo(h+f-sizes.back.dotsize*sizes.scale,i+g+sizes.back.dotsize*sizes.scale),ctx.stroke();ctx.fillStyle="rgba(200,200,200,0.02)",ctx.fillRect(d,e,sizes.back.size*sizes.scale,sizes.back.size*sizes.scale);for(var j in players){var k=players[j];ctx.save(),ctx.translate(canvas.width/2-sizes.back.size*sizes.scale*(b.x-k.x),canvas.height/2-sizes.back.size*sizes.scale*(b.y-k.y)),ctx.rotate(k.Angle+3*Math.PI/2),ctx.beginPath(),ctx.arc(0,0,sizes.ball*sizes.scale,Math.PI,0),ctx.arc(0,0,2*k.Beam.length*k.Speed.val*sizes.scale,-k.Beam.angle+Math.PI/2,k.Beam.angle+Math.PI/2),ctx.closePath(),view=ctx.createRadialGradient(0,0,sizes.ball*sizes.scale,0,0,Math.max(k.Beam.length*sizes.scale*2*k.Speed.val,sizes.ball*sizes.scale)),view.addColorStop(0,"rgba(255,255,255,0.6)"),view.addColorStop(1,"rgba(255,255,255,0.1)"),ctx.fillStyle=view,ctx.fill(),ctx.restore()}for(j in players)k=players[j],ctx.save(),ctx.translate(canvas.width/2-sizes.back.size*sizes.scale*(b.x-k.x),canvas.height/2-sizes.back.size*sizes.scale*(b.y-k.y)),ctx.fillStyle="rgb(255,"+(Math.round(k.Health)+155)+","+(Math.round(k.Health)+155)+")",ctx.beginPath(),ctx.arc(0,0,sizes.ball*sizes.scale,0,2*Math.PI),ctx.closePath(),ctx.fill(),ctx.fillStyle="#AAA",ctx.fillText(k.Name.substr(0,1).toUpperCase(),0,sizes.ball*sizes.scale/4,20),ctx.restore();FPS.calcFPS&&(c=Date.now()-FPS.lastCount)>=500&&(FPS.div.innerHTML=Math.round(FPS.framesShown/c*1e3),FPS.lastCount=Date.now(),FPS.framesShown=0),FPS.framesShown++,requestAnimationFrame(a)}(),socket.on("u",function(a){players=a;var b=document.getElementById("coord");(Base=players[socket.id])?b.innerHTML=String.fromCharCode(65+~~(9.999999999*Base.x))+" "+(~~(9.999999999*Base.y)+1):b.innerHTML=""}),socket.on("si",function(a){var b=document.getElementById("si");document.getElementById("siN").innerHTML="Server: "+a.name,document.getElementById("siR").innerHTML="Region: "+a.region,b.style.height="auto",b.style.paddingBottom="5px"}),socket.on("b",function(a){var b=document.getElementById("score");Base&&Base.Health.val&&(b.style.height="20px",b.innerHTML=Math.round(Base.Score));for(var c=document.getElementById("leaders");c.firstChild;)c.removeChild(c.firstChild);for(var d=0;d<a.length;++d){var e=document.createElement("span"),f=document.createElement("span"),g=document.createTextNode(escapeHTML(a[d].Name));f.className="score",a[d].ID==="/#"+socket.id&&(f.className+=" your",e.className="your",b.style.height=0),f.appendChild(document.createTextNode(Math.round(a[d].Score))),c.appendChild(e).appendChild(f).parentNode.appendChild(g)}}),socket.on("d",function(a){Base.Health=0,document.getElementById("output").innerHTML=(a.type?"You collided with ":"You were killed by ")+(escapeHTML(a.user).trim()||"an anonymous Wacher"),openHome()}),$("button.settings").click(function(){this.style.transform&&"none"!==this.style.transform?(this.style.transform="",$("section.settings").css({"max-height":40,"padding-top":0}).removeClass("closed")):(this.style.transform="rotate(-120deg)",$("section.settings").css({"max-height":500,"padding-top":40}).addClass("closed"))}),document.getElementsByClassName("fps check")[0].onclick=toggleFPS,document.getElementsByClassName("coord check")[0].onclick=toggleCoords,socket.on("console",function(a){console.log(a)}),window.onmousedown=function(){socket.emit("p",1)},window.onmouseup=function(){socket.emit("p",0)},canvas.onselectstart=function(){return!1};