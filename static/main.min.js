window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)});function escapeHTML(a){var b={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return a.replace(/[&<>"']/g,function(a){return b[a]})}
var canvas=document.getElementById("map"),ctx=canvas.getContext("2d"),socket=io(),FPS={lastShow:0,lastCount:0,framesShown:0,calcFPS:!1,div:document.getElementById("fps")},sizes={back:{size:2E3,spacing:200,dotsize:3},ball:30,glow:0,scale:1},lastM=0,players={},view="#FFF",Base;function setCanvas(){canvas.width=$(document).width();canvas.height=$(document).height();ctx.font="bold "+Math.round(.5*sizes.ball*sizes.scale)+"px Rubik";ctx.textAlign="center"}(window.onresize=setCanvas)();
$(window).keydown(function(a){27===a.which?openHome():16===a.which?toggleFPS():67===a.which&&toggleCoords()});window.onwheel=function(a){sizes.scale=Math.min(Math.max(sizes.scale-a.deltaY/1500,300/(Base?Base.Beam.length:500)),2);ctx.font="bold "+Math.round(.5*sizes.ball*sizes.scale)+"px Rubik"};document.getElementById("play").onclick=joinGame;document.getElementById("inform").onsubmit=function(a){joinGame();a.preventDefault();return!1};
(function draw(){var b=Base||{x:.5,y:.5},d,c=canvas.width/2-sizes.back.size*sizes.scale*b.x,f=canvas.height/2-sizes.back.size*sizes.scale*b.y,e=c%(sizes.back.spacing*sizes.scale),g=f%(sizes.back.spacing*sizes.scale);ctx.clearRect(0,0,canvas.width,canvas.height);ctx.fillStyle="#112632";for(var h=-sizes.back.spacing*sizes.scale;h<canvas.width+sizes.back.spacing*sizes.scale;h+=sizes.back.spacing*sizes.scale)for(var k=-sizes.back.spacing*sizes.scale;k<canvas.height+sizes.back.spacing*sizes.scale;k+=sizes.back.spacing*
    sizes.scale)ctx.beginPath(),ctx.arc(h+e,k+g,sizes.back.dotsize*sizes.scale,0,2*Math.PI),ctx.closePath(),ctx.fill();ctx.fillStyle="rgba(255,255,255,0.05)";ctx.fillRect(c,f,sizes.back.size*sizes.scale,sizes.back.size*sizes.scale);for(var l in players)c=players[l],ctx.save(),ctx.translate(canvas.width/2-sizes.back.size*sizes.scale*(b.x-c.x),canvas.height/2-sizes.back.size*sizes.scale*(b.y-c.y)),ctx.rotate(c.Angle+3*Math.PI/2),ctx.beginPath(),ctx.arc(0,0,sizes.ball*sizes.scale,Math.PI,0),ctx.arc(0,0,
    2*c.Beam.length*c.Speed.val*sizes.scale,-c.Beam.angle+Math.PI/2,c.Beam.angle+Math.PI/2),ctx.closePath(),view=ctx.createRadialGradient(0,0,sizes.ball*sizes.scale,0,0,Math.max(c.Beam.length*sizes.scale*2*c.Speed.val,sizes.ball*sizes.scale)),view.addColorStop(0,"rgba(255,255,255,0.6)"),view.addColorStop(1,"rgba(255,255,255,0.1)"),ctx.fillStyle=view,ctx.fill(),ctx.restore();for(l in players)c=players[l],ctx.save(),ctx.translate(canvas.width/2-sizes.back.size*sizes.scale*(b.x-c.x),canvas.height/2-sizes.back.size*
    sizes.scale*(b.y-c.y)),ctx.fillStyle="rgb(255,"+(Math.round(c.Health)+155)+","+(Math.round(c.Health)+155)+")",ctx.beginPath(),ctx.arc(0,0,sizes.ball*sizes.scale+sizes.glow,0,2*Math.PI),ctx.closePath(),ctx.fill(),ctx.fillStyle="#AAA",ctx.fillText(c.Name.substr(0,1).toUpperCase(),0,sizes.ball*sizes.scale/4,20),ctx.restore();FPS.calcFPS&&500<=(d=Date.now()-FPS.lastCount)&&(FPS.div.innerHTML=Math.round(FPS.framesShown/d*1E3),FPS.lastCount=Date.now(),FPS.framesShown=0);FPS.framesShown++;requestAnimationFrame(draw)})();
socket.on("u",function(a){players=a;a=document.getElementById("coord");(Base=players["/#"+socket.id])?a.innerHTML=String.fromCharCode(65+~~(9.999999999*Base.x))+" "+(~~(9.999999999*Base.y)+1):a.innerHTML=""});socket.on("si",function(a){var b=document.getElementById("si");document.getElementById("siN").innherHTML="Server: "+a.name;document.getElementById("siR").innherHTML="Region: "+a.region;b.style.height="auto";b.style.paddingBottom="5px"});
socket.on("b",function(a){var b=document.getElementById("score");Base&&Base.Health.val&&(b.style.height="20px",b.innerHTML=Math.round(Base.Score));for(var d=document.getElementById("leaders");d.firstChild;)d.removeChild(d.firstChild);for(var c=0;c<a.length;++c){var f=document.createElement("span"),e=document.createElement("span"),g=document.createTextNode(escapeHTML(a[c].Name));e.className="score";a[c].ID==="/#"+socket.id&&(e.className+=" your",f.className="your",b.style.height=0);e.appendChild(document.createTextNode(Math.round(a[c].Score)));
    d.appendChild(f).appendChild(e).parentNode.appendChild(g)}});socket.on("d",function(a){Base.Health=0;document.getElementById("output").innerHTML="You were killed by "+(escapeHTML(a.user).trim()||"an anonymous Wacher");openHome()});
$("button.settings").click(function(){this.style.transform&&"none"!==this.style.transform?(this.style.transform="",$("section.settings").css({"max-height":40,"padding-top":0}).removeClass("closed")):(this.style.transform="rotate(-120deg)",$("section.settings").css({"max-height":500,"padding-top":40}).addClass("closed"))});document.getElementsByClassName("fps check")[0].onclick=toggleFPS;document.getElementsByClassName("coord check")[0].onclick=toggleCoords;
function toggleFPS(){var a=document.getElementById("fpsc"),b=document.getElementsByClassName("fps check")[0];FPS.calcFPS?(b.style.background="none",a.style.opacity=0,setTimeout(function(){a.className=""},300)):(b.style.background="#444",a.className="overlays",a.style.opacity=1);FPS.calcFPS=!FPS.calcFPS}
function joinGame(){socket.emit("join",{usr:document.getElementById("wacher").value});hideHome();document.onmousemove=function(a){if(20<Date.now()-lastM){var b=Math.sqrt(Math.pow($(document).width()/2-a.pageX,2)+Math.pow($(document).height()/2-a.pageY,2))/sizes.scale;a=Math.atan2(a.pageY-$(document).height()/2,a.pageX-$(document).width()/2);socket.emit("i",{a:a,d:b});lastM=Date.now()}}}
function hideHome(){var a=document.getElementById("home");a.style.opacity=0;$(".overlays").css("opacity",1);$("button.settings").attr("style","");$("section.settings").css({"max-height":40,"padding-top":0}).addClass("closed");setTimeout(function(){a.style.zIndex=-1},300)}function openHome(){$("#home").css({opacity:1,"z-index":0});$(".overlays").css("opacity",0);document.onmousemove=null}
function toggleCoords(){var a=document.getElementById("coord"),b=document.getElementsByClassName("coord check")[0];b.style.background&&"none"!==b.style.background?(b.style.background="none",a.style.opacity=0,setTimeout(function(){a.className=""},300)):(b.style.background="#444",a.className="overlays",a.style.opacity=1)}socket.on("console",function(a){console.log(a)});